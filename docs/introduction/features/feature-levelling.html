

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Feature Levelling &mdash; The Xen Project unknown version documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Intel Cache Allocation Technology and Code and Data Prioritization Features" href="intel_psr_cat_cdp.html" />
    <link rel="prev" title="Dom0less" href="dom0less.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Xen Project
          

          
          </a>

          
            
            
              <div class="version">
                unknown version
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction to Xen</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Xen Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Features</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dom0less.html">Dom0less</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Feature Levelling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-details">User Details</a></li>
<li class="toctree-l3"><a class="reference internal" href="#technical-details">Technical Details</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#controlling-cpuid">Controlling CPUID</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#host-boot">Host Boot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#domain-creation">Domain Creation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#known-issues-areas-for-improvement">Known issues / Areas for improvement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changelog">Changelog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="intel_psr_cat_cdp.html">Intel Cache Allocation Technology and Code and Data Prioritization Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="intel_psr_mba.html">Intel Memory Bandwidth Allocation (MBA) Feature</a></li>
<li class="toctree-l2"><a class="reference internal" href="livepatch.html">Live Patching</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration.html">Migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="qemu-deprivilege.html">QEMU Deprivileging / dm_restrict</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched_credit.html">Credit Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched_credit2.html">Credit2 Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched_rtds.html">RTDS Scheduler</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/booting-xen-u-boot.html">Booting Xen from U-Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/building-xen-arm.html">Building Xen on Arm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/configure-networking.html">Configuring Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/reduce-latency.html">Reducing Latency</a></li>
</ul>
<p class="caption"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/how-xen-boots.html">How Xen Boots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to/code-coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/microcode-loading.html">Microcode Loading</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/hypercall-abi.html">Hypercall ABI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/hypercall-abi.html#hypercall-page">Hypercall Page</a></li>
</ul>
<p class="caption"><span class="caption-text">Glossary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>
<p class="caption"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing to the Xen Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribute-xen/contribute-xen.html">Contributing to Xen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute-xen/submit-patch.html">Submitting Patches to Xen</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Xen Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Features</a> &raquo;</li>
        
      <li>Feature Levelling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/introduction/features/feature-levelling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="feature-levelling">
<h1>Feature Levelling<a class="headerlink" href="#feature-levelling" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Status: <strong>Supported</strong></p></li>
<li><p>Architecture: x86</p></li>
<li><p>Components: Hypervisor, toolstack, guest</p></li>
</ul>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>On native hardware, a kernel boots, detects features, and typically optimizes certain codepaths based on the available features, and expect the features to remain available until the kernel shuts down. The same expectation exists for virtual machines, and it is up to the hypervisor/toolstack to fulfill this expectation for the lifetime of the virtual machine, including across migrate/suspend/resume.</p>
</div>
<div class="section" id="user-details">
<h2>User Details<a class="headerlink" href="#user-details" title="Permalink to this headline">¶</a></h2>
<p>Many factors affect the set of features which a VM may use:</p>
<ul class="simple">
<li><p>The CPU itself</p></li>
<li><p>The BIOS/firmware/microcode version and settings</p></li>
<li><p>The hypervisor version and command line settings</p></li>
<li><p>Further restrictions the toolstack chooses to apply</p></li>
</ul>
<p>A firmware or software upgrade might reduce the available set of features, for example, Intel <a href="#id1"><span class="problematic" id="id2">|reg|</span></a> disabling TSX in a microcode update for certain Haswell/Broadwell processors). The available set of features may also be reduced by editing the settings.</p>
<p>It is unsafe to make any assumptions about features remaining consistent across a host reboot. Xen recalculates all information from scratch at each boot, and provides the information for the toolstack to consume.</p>
<p><cite>xl</cite> currently has no facilities to help the user collect appropriate feature information from relevant hosts and compute appropriate feature specifications for use in host or domain configurations.  (<cite>xl</cite> being a single-host toolstack, it would in any case need external support for accessing remote hosts, for example, via SSH, in the form of automation software like GNU parallel or ansible.)</p>
</div>
<div class="section" id="technical-details">
<h2>Technical Details<a class="headerlink" href="#technical-details" title="Permalink to this headline">¶</a></h2>
<p>The <cite>CPUID</cite> instruction is used by softwares to query for features.  In the virtualisation usecase, guest software should query Xen rather than hardware directly.  However, <cite>CPUID</cite> is an unprivileged instruction which does not fault, complicating the task of hiding hardware features from guests.</p>
<p>Important files:</p>
<ul class="simple">
<li><dl class="simple">
<dt>Hypervisor</dt><dd><ul>
<li><p><cite>xen/arch/x86/cpu/*.c</cite></p></li>
<li><p><cite>xen/arch/x86/cpuid.c</cite></p></li>
<li><p><cite>xen/include/asm-x86/cpuid-autogen.h</cite></p></li>
<li><p><cite>xen/include/public/arch-x86/cpufeatureset.h</cite></p></li>
<li><p><cite>xen/tools/gen-cpuid.py</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><cite>libxc</cite></dt><dd><ul>
<li><p><cite>tools/libxc/xc_cpuid_x86.c</cite></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="section" id="controlling-cpuid">
<h3>Controlling CPUID<a class="headerlink" href="#controlling-cpuid" title="Permalink to this headline">¶</a></h3>
<div class="section" id="hvm">
<h4>HVM<a class="headerlink" href="#hvm" title="Permalink to this headline">¶</a></h4>
<p>HVM guests (using <cite>Intel VT-x</cite> or <cite>AMD SVM</cite>) will unconditionally exit to Xen on all <cite>CPUID</cite> instructions, allowing Xen full control over all information.</p>
</div>
<div class="section" id="pv">
<h4>PV<a class="headerlink" href="#pv" title="Permalink to this headline">¶</a></h4>
<p>The <cite>CPUID</cite> instruction is unprivileged, so executing it in a PV guest will not trap, leaving Xen no direct ability to control the information returned.</p>
</div>
<div class="section" id="xen-forced-emulation-prefix">
<h4>Xen Forced Emulation Prefix<a class="headerlink" href="#xen-forced-emulation-prefix" title="Permalink to this headline">¶</a></h4>
<p>Xen-aware PV software can make use of the ‘Forced Emulation Prefix’</p>
<p>&gt; <cite>ud2a; .ascii ‘xen’; cpuid</cite></p>
<p>which Xen recognises as a deliberate attempt to get the fully-controlled <cite>CPUID</cite> information rather than the hardware-reported information. This only works with cooperative software.</p>
</div>
<div class="section" id="masking-and-override-msrs">
<h4>Masking and Override MSRs<a class="headerlink" href="#masking-and-override-msrs" title="Permalink to this headline">¶</a></h4>
<p>AMD CPUs from the <cite>K8</cite> onwards support _Feature <a href="#id3"><span class="problematic" id="id4">Override_</span></a> MSRs, which allow direct control of the values returned for certain <cite>CPUID</cite> leaves.  These MSRs allow any result to be returned, including the ability to advertise features which are not actually supported.</p>
<p>Intel CPUs between <cite>Nehalem</cite> and <cite>SandyBridge</cite> have differing numbers of _Feature <a href="#id5"><span class="problematic" id="id6">Mask_</span></a> MSRs, which are a simple AND-mask applied to all <cite>CPUID</cite> instructions requesting specific feature bitmap sets. The exact MSRs, and which feature bitmap sets they affect are hardware specific. These MSRs allow features to be hidden by clearing the appropriate bit in the mask, but does not allow unsupported features to be advertised.</p>
</div>
<div class="section" id="cpuid-faulting">
<h4>CPUID Faulting<a class="headerlink" href="#cpuid-faulting" title="Permalink to this headline">¶</a></h4>
<p>Intel CPUs from <cite>IvyBridge</cite> onwards have _CPUID <a href="#id7"><span class="problematic" id="id8">Faulting_</span></a>, which allows Xen to cause <cite>CPUID</cite> instruction executed in PV guests to fault.  This allows Xen full control over all information, exactly like HVM guests.</p>
</div>
<div class="section" id="compile-time">
<h4>Compile time<a class="headerlink" href="#compile-time" title="Permalink to this headline">¶</a></h4>
<p>As some features depend on other features, it is important that, when disabling a certain feature, we disable all features which depend on it. This allows runtime logic to be simplified, by being able to rely on testing only the single appropriate feature, rather than the entire feature dependency chain.</p>
<p>To speed up runtime calculation of feature dependencies, the dependency chain is calculated and flattened by <cite>xen/tools/gen-cpuid.py</cite> to create <cite>xen/include/asm-x86/cpuid-autogen.h</cite> from <cite>xen/include/public/arch-x86/cpufeatureset.h</cite>, allowing the runtime code to disable all dependent features of a specific disabled feature in constant time.</p>
</div>
</div>
</div>
<div class="section" id="host-boot">
<h2>Host Boot<a class="headerlink" href="#host-boot" title="Permalink to this headline">¶</a></h2>
<p>As Xen boots, it will enumerate the features it can see. This is stored as the <em>raw_featureset</em>.</p>
<p>Errata checks and command line arguments are then taken into account to reduce the <em>raw_featureset</em> into the <em>host_featureset</em>, which is the set of features Xen uses. On hardware with masking/override MSRs, the default MSR values are picked from the <em>host_featureset</em>.</p>
<p>The <em>host_featureset</em> is then used to calculate the <em>pv_featureset</em> and <em>hvm_featureset</em>, which are the maximum featuresets Xen is willing to offer to PV and HVM guests respectively.</p>
<p>In addition, Xen will calculate how much control it has over non-cooperative PV <cite>CPUID</cite> instructions, storing this information as <em>levelling_caps</em>.</p>
</div>
<div class="section" id="domain-creation">
<h2>Domain Creation<a class="headerlink" href="#domain-creation" title="Permalink to this headline">¶</a></h2>
<p>The toolstack can query each of the calculated featureset via <cite>XEN_SYSCTL_get_cpu_featureset</cite>, and query for the levelling caps via
<cite>XEN_SYSCTL_get_cpu_levelling_caps</cite>.</p>
<p>These data should be used by the toolstack when choosing the eventual featureset to offer to the guest.</p>
<p>Once a featureset has been chosen, it is set (implicitly or explicitly) via <cite>XEN_DOMCTL_set_cpuid</cite>. Xen will clamp the toolstacks choice to the appropriate PV or HVM featureset. On hardware with masking/override MSRs, the guest cpuid policy is reflected in the MSRs, which are context switched with other vcpu state.</p>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>A guest which ignores the provided feature information and manually probes for features will be able to find some of them.  e.g. There is no way of forcibly preventing a guest from using 1GB superpages if the hardware supports it.</p>
<p>Some information simply cannot be hidden from guests.  There is no way to control certain behaviour such as the hardware MXCSR_MASK or x87 FPU exception behaviour.</p>
</div>
<div class="section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>Feature levelling is a very wide area, and used all over the hypervisor. Ask on xen-devel for help identifying more specific tests which could be of use.</p>
</div>
<div class="section" id="known-issues-areas-for-improvement">
<h2>Known issues / Areas for improvement<a class="headerlink" href="#known-issues-areas-for-improvement" title="Permalink to this headline">¶</a></h2>
<p>The feature querying and levelling functions should exposed in a convenient-to-use way by <cite>xl</cite>.</p>
<p>Xen currently has no concept of per-{socket,core,thread} CPUID information. As a result, details such as APIC IDs, topology and cache information do not match real hardware, and do not match the documented expectations in the Intel and AMD system manuals.</p>
<p>The CPU feature flags are the only information which the toolstack has a sensible interface for querying and levelling. Other information in the CPUID policy is important and should be levelled (for example, maxphysaddr).</p>
<p>The CPUID policy is currently regenerated from scratch by the receiving side, once memory and vcpu content has been restored. This means that the receiving Xen cannot verify the memory/vcpu content against the CPUID policy, and can end up running a guest which will subsequently crash. The CPUID policy should be at the head of the migration stream.</p>
<p>MSRs are another source of features for guests. There is no general provision for controlling the available MSRs, for example, 64-bit versions of Windows notice changes in IA32_MISC_ENABLE, and suffer a BSOD 0x109 (Critical Structure Corruption).</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://www.intel.co.uk/content/dam/www/public/us/en/documents/application-notes/virtualization-technology-flexmigration-application-note.pdf">Intel Flexmigration</a></p></li>
<li><p><a class="reference external" href="http://developer.amd.com/wordpress/media/2012/10/43781-3.00-PUB_Live-Virtual-Machine-Migration-on-AMD-processors.pdf">AMD Extended Migration Technology</a></p></li>
</ul>
</div>
<div class="section" id="changelog">
<h2>Changelog<a class="headerlink" href="#changelog" title="Permalink to this headline">¶</a></h2>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 36%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Date</p></th>
<th class="head"><p>Revision Version</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2016-05-31</p></td>
<td><p>Xen 4.7</p></td>
<td><p>Document written</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="intel_psr_cat_cdp.html" class="btn btn-neutral float-right" title="Intel Cache Allocation Technology and Code and Data Prioritization Features" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dom0less.html" class="btn btn-neutral float-left" title="Dom0less" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, The Xen development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>