

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Hypercall ABI &mdash; The Xen Project unknown version documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Glossary" href="../glossary.html" />
    <link rel="prev" title="Microcode Loading" href="../admin-guide/microcode-loading.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Xen Project
          

          
          </a>

          
            
            
              <div class="version">
                unknown version
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction to Xen</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/architecture.html">Xen Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/features/index.html">Features</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/booting-xen-u-boot.html">Booting Xen from U-Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/building-xen-arm.html">Building Xen on Arm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/configure-networking.html">Configuring Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/reduce-latency.html">Reducing Latency</a></li>
</ul>
<p class="caption"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/how-xen-boots.html">How Xen Boots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/code-coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/microcode-loading.html">Microcode Loading</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hypercall ABI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#registers">Registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parameters">Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mode-transfer">Mode transfer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#hypercall-page">Hypercall Page</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-hypercall-pages">Creating Hypercall Pages</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Glossary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
<p class="caption"><span class="caption-text">FAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing to the Xen Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contribute-xen/contribute-xen.html">Contributing to Xen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute-xen/submit-patch.html">Submitting Patches to Xen</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Xen Project</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Hypercall ABI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/reference/hypercall-abi.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hypercall-abi">
<h1>Hypercall ABI<a class="headerlink" href="#hypercall-abi" title="Permalink to this headline">¶</a></h1>
<p>Hypercalls are system calls to Xen.  Two modes of guest operation are
supported, and up to 6 individual parameters are supported.</p>
<p>Hypercalls may only be issued by kernel-level software <a class="footnote-reference brackets" href="#id4" id="id1">1</a>.</p>
<div class="section" id="registers">
<h2>Registers<a class="headerlink" href="#registers" title="Permalink to this headline">¶</a></h2>
<p>The registers used for hypercalls depends on the operating mode of the guest.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ABI</p></th>
<th class="head"><p>Hypercall Index</p></th>
<th class="head"><p>Parameters (1 - 6)</p></th>
<th class="head"><p>Result</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>64bit</p></td>
<td><p>RAX</p></td>
<td><p>RDI RSI RDX R10 R8 R9</p></td>
<td><p>RAX</p></td>
</tr>
<tr class="row-odd"><td><p>32bit</p></td>
<td><p>EAX</p></td>
<td><p>EBX ECX EDX ESI EDI EBP</p></td>
<td><p>EAX</p></td>
</tr>
</tbody>
</table>
<p>32 and 64bit PV guests have an ABI fixed by their guest type.  The ABI for an
HVM guest depends on whether the vCPU is operating in a 64bit segment or not
<a class="footnote-reference brackets" href="#id5" id="id2">2</a>.</p>
</div>
<div class="section" id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h2>
<p>Different hypercalls take a different number of parameters.  Each hypercall
potentially clobbers each of its parameter registers; a guest may not rely on
the parameter registers staying the same.  A debug build of Xen checks this by
deliberately poisoning the parameter registers before returning back to the
guest.</p>
</div>
<div class="section" id="mode-transfer">
<h2>Mode transfer<a class="headerlink" href="#mode-transfer" title="Permalink to this headline">¶</a></h2>
<p>The exact sequence of instructions required to issue a hypercall differs
between virtualisation mode and hardware vendor.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Guest</p></th>
<th class="head"><p>Transfer instruction</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>32bit PV</p></td>
<td><p>INT 0x82</p></td>
</tr>
<tr class="row-odd"><td><p>64bit PV</p></td>
<td><p>SYSCALL</p></td>
</tr>
<tr class="row-even"><td><p>Intel HVM</p></td>
<td><p>VMCALL</p></td>
</tr>
<tr class="row-odd"><td><p>AMD HVM</p></td>
<td><p>VMMCALL</p></td>
</tr>
</tbody>
</table>
<p>To abstract away the details, Xen implements an interface known as the
Hypercall Page.  This allows a guest to make a hypercall without needing to
perform mode-specific or vendor-specific setup.</p>
</div>
</div>
<div class="section" id="hypercall-page">
<h1>Hypercall Page<a class="headerlink" href="#hypercall-page" title="Permalink to this headline">¶</a></h1>
<p>The hypercall page is a page of guest RAM into which Xen will write suitable
transfer stubs.</p>
<p>Creating a hypercall page is an isolated operation from Xen’s point of view.
It is the guests responsibility to ensure that the hypercall page, once
written by Xen, is mapped with executable permissions so it may be used.
Multiple hypercall pages may be created by the guest, if it wishes.</p>
<p>The stubs are arranged by hypercall index, and start on 32-byte boundaries.
To invoke a specific hypercall, <code class="docutils literal notranslate"><span class="pre">call</span></code> the relevant stub <a class="footnote-reference brackets" href="#id6" id="id3">3</a>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>call hypercall_page + index * 32
</pre></div>
</div>
<p>There result is an ABI which is invariant of the exact operating mode or
hardware vendor.  This is intended to simplify guest kernel interfaces by
abstracting away the details of how it is currently running.</p>
<div class="section" id="creating-hypercall-pages">
<h2>Creating Hypercall Pages<a class="headerlink" href="#creating-hypercall-pages" title="Permalink to this headline">¶</a></h2>
<p>Guests which are started using the PV boot protocol may set set
<code class="docutils literal notranslate"><span class="pre">XEN_ELFNOTE_HYPERCALL_PAGE</span></code> to have the nominated page written as a
hypercall page during construction.  This mechanism is common for PV guests,
and allows hypercalls to be issued with no additional setup.</p>
<p>Any guest can locate the Xen CPUID leaves and read the <em>hypercall transfer
page</em> information, which specifies an MSR that can be used to create
additional hypercall pages.  When a guest physical address is written to the
MSR, Xen writes a hypercall page into the nominated guest page.  This
mechanism is common for HVM guests which are typically started via legacy
means.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>For HVM guests, <code class="docutils literal notranslate"><span class="pre">HVMOP_guest_request_vm_event</span></code> may be configured to
be usable from userspace, but this behaviour is not default.</p>
</dd>
<dt class="label" id="id5"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>While it is possible to use compatibility mode segments in a 64bit
kernel, hypercalls issues from such a mode will be interpreted with the
32bit ABI.  Such a setup is not expected in production scenarios.</p>
</dd>
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">HYPERCALL_iret</span></code> is special.  It is only implemented for PV guests
and takes all its parameters on the stack.  This stub should be
<code class="docutils literal notranslate"><span class="pre">jmp</span></code>’d to, rather than <code class="docutils literal notranslate"><span class="pre">call</span></code>’d.  HVM guests have this stub
implemented as <code class="docutils literal notranslate"><span class="pre">ud2a</span></code> to prevent accidental use.</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../glossary.html" class="btn btn-neutral float-right" title="Glossary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../admin-guide/microcode-loading.html" class="btn btn-neutral float-left" title="Microcode Loading" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, The Xen development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>